<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>AR Product Visualizer</title>

<!-- Import Map -->
<script type="importmap">
{
    "imports": {
        "three": "./build/three.module.js",
        "three/addons/": "./jsm/"
    }
}
</script>

<style>
body { margin: 0; overflow: hidden; font-family: Arial; }

/* AR canvas (no touch so UI works) */
canvas {
    position: absolute;
    top:0; left:0;
    width:100vw; height:100vh;
    z-index:0;
    pointer-events: none !important;   /* IMPORTANT FIX */
}

/* AR Start Button */
#startAR {
    position:absolute;
    top:10px; left:10px;
    padding:10px 16px;
    z-index:20;
    background:white;
    border:1px solid #ccc;
    border-radius:8px;
    font-size:16px;
    pointer-events:auto !important;
}

/* Dropdown Main Button */
#modelMenuBtn {
    position:absolute;
    top:60px; left:10px;
    padding:10px 16px;
    z-index:20;
    background:white;
    border:1px solid #ccc;
    border-radius:8px;
    font-size:16px;
    cursor:pointer;
    pointer-events:auto !important;
}

/* Dropdown Panel */
#dropdownPanel {
    position:absolute;
    top:110px; left:10px;
    width:260px;
    background:white;
    border:1px solid #ccc;
    border-radius:6px;
    padding:10px;
    display:none;
    max-height:420px;
    overflow-y:auto;
    z-index:999999 !important;   /* IMPORTANT FIX */
    pointer-events:auto !important;
}

/* Category title */
.category {
    font-weight:bold;
    margin-top:8px;
    cursor:pointer;
    pointer-events:auto !important;
}

/* Items */
.subitem {
    margin-left:15px;
    padding:4px;
    cursor:pointer;
    pointer-events:auto !important;
}
.subitem:hover {
    background:#eee;
    border-radius:4px;
}

/* Dimension overlay */
#dimOverlay {
    position:absolute;
    bottom:10px; left:10px;
    background:rgba(0,0,0,0.55);
    color:white;
    padding:10px 16px;
    border-radius:8px;
    z-index:30;
    font-size:14px;
    pointer-events:auto !important;
}
</style>
</head>

<body>

<button id="startAR">Start AR</button>
<button id="modelMenuBtn">Models ▼</button>

<div id="dropdownPanel"></div>

<div id="dimOverlay">
    <b>Dimensions</b><br>
    Width: -- m<br>
    Height: -- m<br>
    Depth: -- m<br>
    Scale: 1.0x<br>
    Rotation: 0°
</div>

<script type="module">

import * as THREE from "three";
import { ARButton } from "three/addons/webxr/ARButton.js";
import { GLTFLoader } from "three/addons/loaders/GLTFLoader.js";

let scene, camera, renderer;
let reticle;
let hitTestSource = null;
let hitTestRequested = false;
let currentModel = null;
let selectedModelName = null;

/* ------------------------------------------------------------
   Model List
------------------------------------------------------------ */
const modelList = {
    chairs: [
        { name: "Chair 1", file: "chair1.glb" },
        { name: "Chair 2", file: "chair2.glb" },
        { name: "Chair 3", file: "chair3.glb" },
        { name: "Chair 4", file: "chair4.glb" },
        { name: "Chair 5", file: "chair5.glb" },
        { name: "Chair 6", file: "chair6.glb" }
    ],
    special: [
        { name: "Office Chair", file: "office-chair.glb" },
        { name: "Sheen Chair", file: "SheenChair.glb" }
    ],
    objects: [
        { name: "Coffee Mug", file: "coffeeMug.glb" }
    ],
    custom: [
        { name: "Custom GLB", file: "Horse.glb" }
    ]
};

/* ------------------------------------------------------------
   Build Dropdown UI (Multi-level)
------------------------------------------------------------ */
function buildDropdown() {
    const dp = document.getElementById("dropdownPanel");
    dp.innerHTML = "";

    function addCategory(title, items) {
        const cat = document.createElement("div");
        cat.className = "category";
        cat.textContent = title + " ▶";
        dp.appendChild(cat);

        const sub = document.createElement("div");
        sub.style.display = "none";

        items.forEach(m => {
            const s = document.createElement("div");
            s.className = "subitem";
            s.textContent = m.name;
            s.onclick = () => {
                selectedModelName = m.file;
                dp.style.display = "none";
            };
            sub.appendChild(s);
        });

        dp.appendChild(sub);

        cat.onclick = () => {
            const open = sub.style.display === "block";
            sub.style.display = open ? "none" : "block";
            cat.textContent = title + (open ? " ▶" : " ▼");
        };
    }

    addCategory("Chairs", modelList.chairs);
    addCategory("Special Chairs", modelList.special);
    addCategory("Objects", modelList.objects);
    addCategory("Custom", modelList.custom);
}
buildDropdown();

/* Toggle dropdown */
document.getElementById("modelMenuBtn").onclick = () => {
    const dp = document.getElementById("dropdownPanel");
    dp.style.display = (dp.style.display === "block") ? "none" : "block";
};

/* ------------------------------------------------------------
   Load Model
------------------------------------------------------------ */
const loader = new GLTFLoader();

function loadModel(name, matrix) {
    loader.load(name, (gltf) => {
        if (currentModel) scene.remove(currentModel);

        currentModel = gltf.scene;
        currentModel.position.setFromMatrixPosition(matrix);
        currentModel.rotation.set(0, 0, 0);
        currentModel.scale.set(1, 1, 1);
        currentModel.visible = true;

        scene.add(currentModel);
        updateDimensions();
    });
}

/* ------------------------------------------------------------
   Update Dimensions
------------------------------------------------------------ */
function updateDimensions() {
    if (!currentModel) return;

    const box = new THREE.Box3().setFromObject(currentModel);
    const size = new THREE.Vector3();
    box.getSize(size);

    document.getElementById("dimOverlay").innerHTML =
        `<b>Dimensions</b><br>
         Width: ${size.x.toFixed(2)} m<br>
         Height: ${size.y.toFixed(2)} m<br>
         Depth: ${size.z.toFixed(2)} m<br>
         Scale: ${currentModel.scale.x.toFixed(2)}x<br>
         Rotation: ${(currentModel.rotation.y * 57.3).toFixed(0)}°`;
}

/* ------------------------------------------------------------
   Gestures (Drag, Scale, Rotate)
------------------------------------------------------------ */
let dragging = false;
let prevDist = 0;
let prevAngle = 0;

window.addEventListener("touchstart", (e) => {
    if (!currentModel) return;

    if (e.touches.length === 1) dragging = true;

    if (e.touches.length === 2) {
        prevDist = dist(e);
        prevAngle = angle(e);
    }
});

window.addEventListener("touchmove", (e) => {
    if (!currentModel) return;

    if (dragging && e.touches.length === 1) {
        currentModel.position.setFromMatrixPosition(reticle.matrix);
        updateDimensions();
    }

    if (e.touches.length === 2) {
        // Scale
        const d = dist(e);
        currentModel.scale.multiplyScalar(d / prevDist);
        prevDist = d;

        // Rotate
        const a = angle(e);
        currentModel.rotation.y += (a - prevAngle) * 0.01;
        prevAngle = a;

        updateDimensions();
    }
});

window.addEventListener("touchend", () => dragging = false);

function dist(e) {
    return Math.hypot(
        e.touches[0].clientX - e.touches[1].clientX,
        e.touches[0].clientY - e.touches[1].clientY
    );
}
function angle(e) {
    return Math.atan2(
        e.touches[1].clientY - e.touches[0].clientY,
        e.touches[1].clientX - e.touches[0].clientX
    );
}

/* ------------------------------------------------------------
   INIT
------------------------------------------------------------ */
function init() {

    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 40);

    renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.xr.enabled = true;
    document.body.appendChild(renderer.domElement);

    scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 1.2));

    // Reticle
    reticle = new THREE.Mesh(
        new THREE.RingGeometry(0.04, 0.05, 32).rotateX(-Math.PI/2),
        new THREE.MeshBasicMaterial({ color:0xffffff, opacity:0.9, transparent:true })
    );
    reticle.matrixAutoUpdate = false;
    reticle.visible = false;
    scene.add(reticle);

    // Tap to place
    const controller = renderer.xr.getController(0);
    controller.addEventListener("select", () => {
        if (selectedModelName && reticle.visible) {
            loadModel(selectedModelName, reticle.matrix);
        }
    });
    scene.add(controller);

    // AR Button
    const arBtn = ARButton.createButton(renderer, {
        requiredFeatures: ["hit-test"],
        optionalFeatures: ["dom-overlay"],
        domOverlay: { root: document.body }
    });
    document.body.appendChild(arBtn);

    document.getElementById("startAR").onclick = () => arBtn.click();

    renderer.xr.addEventListener("sessionend", () => {
        currentModel = null;
        hitTestRequested = false;
        hitTestSource = null;
    });

    renderer.setAnimationLoop(render);

    // IMPORTANT FIX: Force UI activation in AR mode
    document.body.addEventListener("touchstart", () => {}, { passive:true });

    window.addEventListener("resize", () =>
        renderer.setSize(window.innerWidth, window.innerHeight)
    );
}

/* ------------------------------------------------------------
   RENDER LOOP + HIT TEST
------------------------------------------------------------ */
function render(t, frame) {

    if (frame) {
        const session = renderer.xr.getSession();

        if (!hitTestRequested) {

            session.requestReferenceSpace("viewer").then((viewerSpace) => {
                session.requestHitTestSource({ space: viewerSpace })
                .then((source) => hitTestSource = source);
            });

            session.requestReferenceSpace("local").then((refSpace) =>
                renderer.xr.setReferenceSpace(refSpace)
            );

            hitTestRequested = true;
        }

        if (hitTestSource) {
            const refSpace = renderer.xr.getReferenceSpace();
            const hits = frame.getHitTestResults(hitTestSource);

            if (hits.length > 0) {
                const hit = hits[0].getPose(refSpace);
                reticle.visible = true;
                reticle.matrix.fromArray(hit.transform.matrix);
                reticle.position.y += 0.002;
            } else {
                reticle.visible = false;
            }
        }
    }

    renderer.render(scene, camera);
}

/* ------------------------------------------------------------ */
init();
</script>

</body>
</html>
